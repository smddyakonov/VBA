Исходные данные:

Основная таблица: Содержит список заказов с номерами и названиями товаров.
Выходной диапазон: Список номеров заказов, для которых необходимо собрать все товары.
Функционал макроса:

Для каждого номера заказа в выходном диапазоне макрос находит все соответствующие товары в основной таблице.
Объединяет названия товаров в одну строку, разделённую запятыми.
Записывает результат рядом с соответствующим номером заказа в выходном диапазоне.
Если номер заказа из выходного диапазона не найден в основной таблице, выводит сообщение об ошибке в соответствующей ячейке.

Пошаговая инструкция по использованию макроса
Подготовьте данные в Excel:

Основная таблица:
Столбец A: Номера заказов (начиная с ячейки A2).
Столбец B: Названия товаров (начиная с ячейки B2).
Выходной диапазон:
Столбец D: Список номеров заказов, для которых нужно собрать товары (начиная с ячейки D2).
Столбец E: Будет заполнен результатом (объединённые названия товаров).
Вставьте макрос в VBA редактор:

Нажмите Alt + F11 в Excel, чтобы открыть редактор VBA.
В редакторе выберите Insert > Module, чтобы добавить новый модуль.
Вставьте приведённый ниже код в модуль.

Sub ExtractOrderItemsToOutputRange()
    Dim ws As Worksheet
    Dim mainDataLastRow As Long
    Dim outputLastRow As Long
    Dim mainOrderRange As Range
    Dim outputOrderRange As Range
    Dim orderDict As Object
    Dim cell As Range
    Dim orderNumber As Variant
    Dim itemName As String
    Dim outputCell As Range
    Dim notFoundOrders As Collection
    Dim msg As String
    
    ' Инициализируем словарь и коллекцию для не найденных заказов
    Set orderDict = CreateObject("Scripting.Dictionary")
    Set notFoundOrders = New Collection
    
    ' Указываем рабочий лист (замените "Sheet1" на имя вашего листа, если необходимо)
    Set ws = ThisWorkbook.Sheets("Sheet1")
    
    ' Определяем последнюю заполненную строку в основной таблице (столбец A)
    mainDataLastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    ' Определяем диапазон основной таблицы (номера заказов в A, товары в B)
    Set mainOrderRange = ws.Range("A2:A" & mainDataLastRow)
    
    ' Заполняем словарь: ключ - номер заказа, значение - список товаров
    For Each cell In mainOrderRange
        orderNumber = cell.Value
        itemName = cell.Offset(0, 1).Value ' Предполагаем, что товары в столбце B
        
        ' Проверяем, не пустой ли номер заказа
        If Not IsEmpty(orderNumber) Then
            If orderDict.Exists(orderNumber) Then
                ' Добавляем товар к существующему списку
                orderDict(orderNumber) = orderDict(orderNumber) & ", " & itemName
            Else
                ' Создаём новый список товаров для заказа
                orderDict.Add orderNumber, itemName
            End If
        End If
    Next cell
    
    ' Определяем последнюю заполненную строку в выходном диапазоне (столбец D)
    outputLastRow = ws.Cells(ws.Rows.Count, "D").End(xlUp).Row
    
    ' Определяем диапазон выходных заказов (столбец D)
    Set outputOrderRange = ws.Range("D2:D" & outputLastRow)
    
    ' Обходим каждый заказ в выходном диапазоне и записываем результаты
    For Each outputCell In outputOrderRange
        orderNumber = outputCell.Value
        
        ' Проверяем, не пустой ли номер заказа
        If Not IsEmpty(orderNumber) Then
            If orderDict.Exists(orderNumber) Then
                ' Записываем объединённые товары в столбец E
                outputCell.Offset(0, 1).Value = orderDict(orderNumber)
            Else
                ' Если заказ не найден, записываем сообщение об ошибке
                outputCell.Offset(0, 1).Value = "Заказ не найден"
                ' Добавляем номер заказа в коллекцию не найденных
                notFoundOrders.Add orderNumber
            End If
        Else
            ' Если ячейка пуста, очищаем соответствующую ячейку в выходном столбце
            outputCell.Offset(0, 1).ClearContents
        End If
    Next outputCell
    
    ' Если есть не найденные заказы, выводим сообщение
    If notFoundOrders.Count > 0 Then
        msg = "Некоторые заказы не были найдены:" & vbCrLf
        For Each orderNumber In notFoundOrders
            msg = msg & orderNumber & vbCrLf
        Next orderNumber
        MsgBox msg, vbExclamation, "Заказы не найдены"
    Else
        MsgBox "Все заказы успешно обработаны.", vbInformation, "Готово"
    End If
    
    ' Очистка объектов
    Set orderDict = Nothing
    Set notFoundOrders = Nothing
End Sub

Пояснение к коду
Переменные:

ws: Ссылается на рабочий лист, содержащий данные. Замените "Sheet1" на актуальное имя листа, если необходимо.

mainDataLastRow: Последняя заполненная строка в основной таблице (столбец A).

outputLastRow: Последняя заполненная строка в выходном диапазоне (столбец D).

mainOrderRange: Диапазон с номерами заказов в основной таблице.

outputOrderRange: Диапазон с номерами заказов для вывода.

orderDict: Словарь для хранения соответствий между номерами заказов и списком товаров.

notFoundOrders: Коллекция для хранения номеров заказов, которые не были найдены в основной таблице.

Алгоритм работы:

Шаг 1: Создаётся словарь orderDict, где ключами являются номера заказов, а значениями — объединённые названия товаров.

Шаг 2: Обход основной таблицы для заполнения словаря.

Шаг 3: Обход выходного диапазона (столбец D). Для каждого номера заказа проверяется наличие в словаре:

Если найден, записываются все товары в соответствующую ячейку столбца E.
Если не найден, в ячейку столбца E записывается сообщение "Заказ не найден", и номер заказа добавляется в коллекцию notFoundOrders.
Шаг 4: После обработки всех заказов, если есть не найденные заказы, выводится сообщение с их перечнем. В противном случае, выводится сообщение о успешной обработке всех заказов.

Настройка диапазонов:

Основная таблица:
Номера заказов находятся в столбце A, начиная с ячейки A2.
Названия товаров находятся в столбце B.
Выходной диапазон:
Номера заказов для вывода находятся в столбце D, начиная с ячейки D2.
Результаты будут записаны в столбец E, рядом с соответствующими номерами заказов.
Обработка ошибок:

Если в выходном диапазоне есть номера заказов, которых нет в основной таблице, макрос отмечает это сообщением "Заказ не найден" в соответствующей ячейке и выводит итоговый список таких заказов в сообщении.
